# Data Agent Web 前端功能测试计划

## 1. 测试范围和目标

### 1.1 测试范围

| 模块 | 组件文件 | 测试重点 |
|------|---------|---------|
| Header | `Header.tsx` | Logo、会话信息、数据库状态、模式设置按钮 |
| Sidebar | `Sidebar.tsx` | 数据库浏览、模型列表、导出文件、展开/收起 |
| Workspace | `MainWorkspace.tsx`, `SecondaryWorkspace.tsx` | Tab 切换、主/副工作区、历史查看 |
| ChatSidebar | `ChatSidebar.tsx` | 消息发送、对话历史、加载动画、清空功能 |
| ModeControl | `ModeControl.tsx` | 6 种模式的获取与设置 |
| DataDisplay | `CodeViewer.tsx`, `DataTable.tsx` | 数据表格、代码语法高亮 |
| API Proxy | `/app/api/**/*.ts` | 所有前端 API 路由代理 |

### 1.2 测试目标

1. **功能完整性**：验证所有 UI 组件按设计规格正确工作
2. **交互正确性**：确保用户操作产生预期的界面响应
3. **API 集成**：验证前端与后端 API 的通信正确
4. **异常处理**：确保错误场景有适当的用户反馈
5. **数据展示**：验证各类数据（SQL 结果、Python 输出、模型信息等）正确渲染

---

## 2. 测试环境要求

### 2.1 软件环境

| 组件 | 版本要求 |
|------|---------|
| Node.js | >= 18.x |
| Python | >= 3.10 |
| 后端服务 | `data_agent.api.main` 运行于 8000 端口 |
| 前端开发服务器 | Next.js 运行于 3000 端口 |

### 2.2 测试数据准备

1. **数据库**：准备测试数据库，包含至少 3-5 张测试表
2. **测试模型**：预训练 1-2 个 ML 模型用于模型列表测试
3. **导出文件**：准备不同类型的导出文件（CSV、JSON 等）


---

## 3. 详细测试用例

### 3.1 Header 组件测试 (7 个用例)

| 编号 | 用例名称 | 优先级 | 测试步骤 | 预期结果 |
|------|---------|--------|----------|----------|
| TC-H-001 | Logo 和标题显示 | P1 | 打开应用首页 | 显示蓝色 "DA" Logo 和 "Data Agent" 标题 |
| TC-H-002 | 会话 ID 显示 | P1 | 打开应用，等待加载 | 显示 "会话: xxxxxxxx"（最后 8 位） |
| TC-H-003 | 数据库已连接状态 | P1 | 配置数据库后打开应用 | 绿色圆点 + "已连接" |
| TC-H-004 | 数据库未连接状态 | P2 | 移除数据库配置 | 红/灰色圆点 + "未连接" |
| TC-H-005 | 模式设置按钮点击 | P1 | 点击 "模式设置" 按钮 | 显示模式设置弹出面板 |
| TC-H-006 | 模式设置面板关闭 | P1 | 点击面板 "✕" 按钮 | 面板关闭并隐藏 |
| TC-H-007 | 会话信息加载失败 | P2 | 停止后端服务后刷新 | 不显示会话 ID，页面不崩溃 |

### 3.2 Sidebar 组件测试 (10 个用例)

| 编号 | 用例名称 | 优先级 | 测试步骤 | 预期结果 |
|------|---------|--------|----------|----------|
| TC-S-001 | 数据库浏览器展开/收起 | P1 | 点击标题切换 | 箭头 ▼/▶ 切换，列表展开/收起 |
| TC-S-002 | 表列表加载 | P1 | 展开数据库浏览器 | 显示所有表，表名前有图标 |
| TC-S-003 | 表列表加载失败 | P2 | 数据库未连接时展开 | 显示 "未连接数据库" |
| TC-S-004 | 点击表名查看详情 | P1 | 点击任意表名 | 切换到副工作区，显示表结构 |
| TC-S-005 | 已训练模型列表展开 | P2 | 点击 "已训练模型" 展开 | 显示模型列表 |
| TC-S-006 | 模型列表为空 | P2 | 无模型时展开 | 显示 "暂无模型" |
| TC-S-007 | 点击模型查看详情 | P2 | 点击任意模型 | 切换到副工作区，显示模型详情 |
| TC-S-008 | 导出文件列表加载 | P1 | 展开 "导出文件" 部分 | 显示文件列表 |
| TC-S-009 | 导出文件列表为空 | P2 | 无文件时展开 | 显示 "暂无导出" |
| TC-S-010 | 点击导出文件查看详情 | P1 | 点击任意文件 | 显示文件名、大小、下载按钮 |

### 3.3 Workspace 组件测试 (9 个用例)

| 编号 | 用例名称 | 优先级 | 测试步骤 | 预期结果 |
|------|---------|--------|----------|----------|
| TC-W-001 | 主工作区 Tab 默认选中 | P1 | 打开应用 | "主工作区" Tab 选中，蓝色边框 |
| TC-W-002 | Tab 切换到副工作区 | P1 | 副工作区有内容时点击 Tab | 切换显示副工作区内容 |
| TC-W-003 | 副工作区 Tab 无内容时禁用 | P1 | 未点击侧边栏项目时 | Tab 灰色禁用，点击无响应 |
| TC-W-004 | 主工作区等待状态 | P1 | 无工具执行结果时 | 显示图标 + "等待 AI 执行操作..." |
| TC-W-005 | SQL 执行结果显示 | P1 | AI 执行 SQL 后 | 显示 SQL（语法高亮）+ 结果表格 |
| TC-W-006 | Python 执行结果显示 | P1 | AI 执行 Python 后 | 显示代码（语法高亮）+ 执行输出 |
| TC-W-007 | 模型训练结果显示 | P2 | AI 训练模型后 | 显示模型类型、目标列、训练结果 |
| TC-W-008 | 历史查看模式进入 | P2 | 触发历史步骤查看 | 显示提示条 + "退出历史查看" 按钮 |
| TC-W-009 | 历史查看模式退出 | P2 | 点击退出按钮 | 返回实时模式，提示条消失 |

### 3.4 SecondaryWorkspace 副工作区测试 (6 个用例)

| 编号 | 用例名称 | 优先级 | 测试步骤 | 预期结果 |
|------|---------|--------|----------|----------|
| TC-SW-001 | 无内容提示 | P2 | 切换到空副工作区 | 显示 "点击左侧边栏项目查看详情" |
| TC-SW-002 | 表结构详情显示 | P1 | 点击侧边栏表名后 | 标题 "表结构: {表名}"，显示结构信息 |
| TC-SW-003 | 表结构加载失败 | P2 | API 返回错误时 | 显示 "加载失败" |
| TC-SW-004 | 导出文件详情显示 | P1 | 点击导出文件后 | 显示文件名、大小（格式化）、下载按钮 |
| TC-SW-005 | 导出文件下载 | P1 | 点击 "下载文件" 按钮 | 触发文件下载 |
| TC-SW-006 | 返回主工作区 | P1 | 点击 "返回主工作区" 按钮 | 切换到主工作区，Tab 更新 |

### 3.5 ChatSidebar 聊天组件测试 (12 个用例)

| 编号 | 用例名称 | 优先级 | 测试步骤 | 预期结果 |
|------|---------|--------|----------|----------|
| TC-C-001 | 初始欢迎消息 | P1 | 打开应用 | 显示助手欢迎消息 |
| TC-C-002 | 发送消息 - Enter 键 | P1 | 输入消息，按 Enter | 消息发送，输入框清空，显示用户消息 |
| TC-C-003 | 换行 - Shift+Enter | P1 | 输入内容，按 Shift+Enter | 不发送，插入换行 |
| TC-C-004 | 发送消息 - 点击按钮 | P1 | 输入消息，点击发送 | 与 Enter 效果相同 |
| TC-C-005 | 空消息不可发送 | P1 | 输入框为空时尝试发送 | 发送按钮禁用，Enter 无响应 |
| TC-C-006 | 加载动画显示 | P1 | 消息发送后等待响应 | 三个跳动圆点，输入框禁用 |
| TC-C-007 | 助手响应显示 | P1 | 后端返回响应后 | 助手消息显示，动画消失，输入框恢复 |
| TC-C-008 | 清空对话 | P1 | 点击 "清空" 按钮 | 对话清空，显示初始欢迎消息 |
| TC-C-009 | 消息自动滚动 | P2 | 发送多条消息 | 新消息出现时自动滚动到底部 |
| TC-C-010 | 发送失败错误处理 | P1 | 后端不可用时发送 | 显示错误消息，输入框恢复可用 |
| TC-C-011 | 用户消息样式 | P2 | 查看用户消息 | 右对齐，蓝色背景，白色文字 |
| TC-C-012 | 助手消息样式 | P2 | 查看助手消息 | 左对齐，灰色背景，深色文字 |

### 3.6 ModeControl 模式管理测试 (9 个用例)

| 编号 | 用例名称 | 优先级 | 测试步骤 | 预期结果 |
|------|---------|--------|----------|----------|
| TC-M-001 | 模式状态加载 | P1 | 打开模式设置面板 | 调用 GET /api/modes，显示所有模式状态 |
| TC-M-002 | 模式加载中状态 | P2 | 打开面板时 | 显示 "加载中..." |
| TC-M-003 | 计划模式切换 | P1 | 切换 off/on/auto | 调用 POST /api/modes/plan，UI 更新 |
| TC-M-004 | 自动执行开关 | P1 | 点击开关 | 调用 API，开启蓝色/关闭灰色 |
| TC-M-005 | 安全模式开关 | P1 | 点击开关 | 调用 API，状态切换 |
| TC-M-006 | 详细输出开关 | P2 | 点击开关 | 调用 API，状态切换 |
| TC-M-007 | 预览行数切换 | P1 | 切换 10/50/100/all | 调用 API，下拉框更新 |
| TC-M-008 | 自动导出开关 | P2 | 点击开关 | 调用 API，状态切换 |
| TC-M-009 | 模式更新失败处理 | P2 | 后端不可用时更新 | 控制台错误，UI 状态不变 |

### 3.7 DataTable 数据表格测试 (6 个用例)

| 编号 | 用例名称 | 优先级 | 测试步骤 | 预期结果 |
|------|---------|--------|----------|----------|
| TC-DT-001 | 空数据显示 | P1 | 查询结果为空 | 显示 "无数据" |
| TC-DT-002 | 表头显示 | P1 | 有查询结果时 | 表头灰色背景，列名大写 |
| TC-DT-003 | 数据行显示 | P1 | 有数据时 | 正确显示所有行，有分隔线 |
| TC-DT-004 | 行悬停效果 | P3 | 鼠标悬停数据行 | 行背景变浅灰色 |
| TC-DT-005 | 行数统计显示 | P2 | 有数据时 | 表格底部显示 "共 X 行" |
| TC-DT-006 | 水平滚动 | P2 | 列数较多时 | 表格可水平滚动 |

### 3.8 CodeViewer 代码查看器测试 (4 个用例)

| 编号 | 用例名称 | 优先级 | 测试步骤 | 预期结果 |
|------|---------|--------|----------|----------|
| TC-CV-001 | SQL 语法高亮 | P1 | 显示 SQL 代码 | 关键字蓝色，字符串绿色，"SQL" 标签 |
| TC-CV-002 | Python 语法高亮 | P1 | 显示 Python 代码 | 关键字紫色，字符串绿色，注释灰色 |
| TC-CV-003 | 代码滚动 | P2 | 代码较长时 | 代码区可滚动，标签固定 |
| TC-CV-004 | 特殊字符转义 | P2 | 代码含 <, >, & | 正确显示，不解析为 HTML |

### 3.9 API 代理测试 (11 个用例)

| 编号 | 用例名称 | 优先级 | 测试步骤 | 预期结果 |
|------|---------|--------|----------|----------|
| TC-API-001 | POST /api/chat | P1 | 发送聊天消息 | 转发到后端，返回响应 |
| TC-API-002 | 流式响应 | P2 | stream=true 请求 | 返回 text/event-stream |
| TC-API-003 | POST /api/chat/reset | P1 | 调用重置 API | 返回成功响应 |
| TC-API-004 | GET /api/sessions | P1 | 获取会话信息 | 返回 session_id 和 export_dir |
| TC-API-005 | GET /api/modes | P1 | 获取模式状态 | 返回所有模式值 |
| TC-API-006 | POST /api/modes/{mode} | P1 | 设置模式值 | 返回更新后的值 |
| TC-API-007 | GET /api/database/tables | P1 | 获取表列表 | 返回 tables 数组 |
| TC-API-008 | GET /api/database/tables/{tableName} | P1 | 获取表结构 | 返回 schema 信息 |
| TC-API-009 | GET /api/sessions/exports | P1 | 获取导出文件列表 | 返回 files 数组 |
| TC-API-010 | GET /api/sessions/exports/{filename} | P1 | 下载导出文件 | 返回文件内容 |
| TC-API-011 | 后端不可用错误处理 | P1 | 后端停止时调用 | 返回 500 错误，明确信息 |

---

## 4. 端到端测试场景 (7 个场景)

| 编号 | 场景名称 | 优先级 | 测试步骤 | 预期结果 |
|------|---------|--------|----------|----------|
| E2E-001 | 完整数据查询流程 | P1 | 1. 打开应用<br>2. 输入 "查询用户表前10条"<br>3. 等待响应<br>4. 查看主工作区 | 聊天显示对话，主工作区显示 SQL + 表格 |
| E2E-002 | 查看表结构后执行查询 | P1 | 1. 点击侧边栏表名<br>2. 查看副工作区<br>3. 返回主工作区<br>4. 发送查询 | 表结构正确，Tab 切换流畅，查询成功 |
| E2E-003 | 模式切换影响行为 | P1 | 1. 打开模式设置<br>2. 开启计划模式<br>3. 发送复杂任务 | 模式切换成功，AI 行为符合设定 |
| E2E-004 | 文件导出和下载 | P2 | 1. 开启自动导出<br>2. 执行查询<br>3. 点击导出文件<br>4. 下载 | 文件出现在列表，下载成功 |
| E2E-005 | 会话重置 | P1 | 1. 进行多轮对话<br>2. 点击清空<br>3. 发送新消息 | 对话清空，新对话正常 |
| E2E-006 | Python 数据分析流程 | P2 | 1. 发送数据分析请求<br>2. 等待执行<br>3. 查看输出 | 代码正确显示，输出正确展示 |
| E2E-007 | 模型训练流程 | P3 | 1. 发送训练请求<br>2. 查看模型列表<br>3. 查看模型详情 | 训练结果显示，模型可查看 |

---

## 5. 测试优先级汇总

### P1 - 关键功能（必须通过）

- Header: TC-H-001, TC-H-002, TC-H-003, TC-H-005, TC-H-006
- Sidebar: TC-S-001, TC-S-002, TC-S-004, TC-S-008, TC-S-010
- Workspace: TC-W-001, TC-W-002, TC-W-003, TC-W-004, TC-W-005, TC-W-006
- SecondaryWorkspace: TC-SW-002, TC-SW-004, TC-SW-005, TC-SW-006
- ChatSidebar: TC-C-001, TC-C-002, TC-C-003, TC-C-004, TC-C-005, TC-C-006, TC-C-007, TC-C-008, TC-C-010
- ModeControl: TC-M-001, TC-M-003, TC-M-004, TC-M-005, TC-M-007
- DataTable: TC-DT-001, TC-DT-002, TC-DT-003
- CodeViewer: TC-CV-001, TC-CV-002
- API: TC-API-001, TC-API-003, TC-API-004, TC-API-005, TC-API-006, TC-API-007, TC-API-008, TC-API-009, TC-API-010, TC-API-011
- E2E: E2E-001, E2E-002, E2E-003, E2E-005

### P2 - 重要功能

- 所有异常处理和边界情况用例
- 样式和交互细节用例
- E2E-004, E2E-006

### P3 - 次要功能

- TC-DT-004 行悬停效果
- TC-C-011, TC-C-012 消息样式
- E2E-007 模型训练流程

---

## 6. 性能和兼容性测试

### 6.1 性能测试

| 测试项 | 验收标准 |
|-------|---------|
| 首屏加载时间 | < 3 秒 |
| 聊天响应延迟 | 发送后 < 500ms 显示加载状态 |
| 大数据表格渲染（1000 行） | < 2 秒 |
| Tab 切换响应 | < 100ms |

### 6.2 浏览器兼容性

| 浏览器 | 最低版本 | 优先级 |
|-------|---------|--------|
| Chrome | 90+ | P1 |
| Firefox | 90+ | P2 |
| Safari | 14+ | P2 |
| Edge | 90+ | P3 |

---

## 7. 验证步骤

### 7.1 启动测试环境

```bash
# 1. 启动后端
cd /Users/frankliu/Code/data_agent
python -m data_agent.api.main

# 2. 启动前端
cd web
npm run dev
```

### 7.2 执行测试

```bash
# 运行组件单元测试
npm run test

# 运行 E2E 测试
npm run test:e2e
```

### 7.3 关键文件

- `web/src/components/chat/ChatSidebar.tsx` - 聊天核心
- `web/src/components/modes/ModeControl.tsx` - 模式管理
- `web/src/components/workspace/MainWorkspace.tsx` - 主工作区
- `web/src/hooks/useWorkspaceContext.tsx` - 状态管理
- `web/src/app/api/chat/route.ts` - Chat API 代理

---

## 8. 测试工具

| 测试类型 | 工具 |
|---------|---------|
| 单元测试 | Jest + React Testing Library |
| E2E 测试 | Playwright |
| API 测试 | Postman / Insomnia |
| 性能测试 | Lighthouse |
