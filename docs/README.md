# Data Agent 项目文档

## 项目概述

**项目名称**: 数据开发 Agent (Data Agent)
**版本**: 0.1.0
**定位**: 基于 LangGraph 框架的智能数据分析 Agent，支持多轮交互对话、自动生成 DAG 执行计划，并能调用丰富的数据分析工具集。

---

## 一、解决的问题

### 1.1 核心痛点

传统数据分析工作面临以下挑战：

1. **技术门槛高** - 数据分析需要掌握 SQL、Python、统计学、机器学习等多种技能
2. **流程繁琐** - 从数据获取、清洗、分析到建模，需要手动编排多个步骤
3. **工具分散** - 不同任务需要切换不同工具（数据库客户端、Jupyter、可视化工具等）
4. **重复劳动** - 类似的分析任务需要反复编写代码

### 1.2 解决方案

Data Agent 通过 **自然语言交互 + 自动任务编排** 解决上述问题：

- **自然语言驱动** - 用户用中文描述需求，Agent 自动理解并生成执行计划
- **自动 DAG 生成** - 将复杂任务拆解为有序的子任务图（DAG），自动处理依赖关系
- **统一工具集成** - 集成 SQL、Python、数据分析、机器学习、图分析等工具
- **可视化确认** - 执行前展示计划，用户确认后才执行，确保可控性

---

## 二、技术架构

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户交互层                                │
│                   CLI 命令行界面 (Rich)                          │
└──────────────────────────┬──────────────────────────────────────┘
                           │
┌──────────────────────────▼──────────────────────────────────────┐
│                      Agent 核心层                                │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │              LangGraph 状态机 (DataAgent)                   │ │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │ │
│  │  │ 对话节点  │→│ 规划节点  │→│ 确认节点  │→│ 执行节点  │   │ │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │ │
│  └────────────────────────────────────────────────────────────┘ │
└───────┬─────────────────┬─────────────────┬─────────────────────┘
        │                 │                 │
   ┌────▼────┐    ┌───────▼───────┐   ┌────▼────────┐
   │状态管理  │    │  DAG 系统     │   │  LLM 集成   │
   │(State)  │    │ 生成/可视化   │   │ (智谱 AI)   │
   └─────────┘    └───────────────┘   └─────────────┘
                          │
┌─────────────────────────▼───────────────────────────────────────┐
│                       工具执行层                                 │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌────────┐│
│  │SQL 工具  │ │Python工具│ │数据分析  │ │机器学习  │ │图分析  ││
│  │MySQL     │ │沙箱执行  │ │pandas    │ │sklearn   │ │networkx││
│  │DuckDB    │ │          │ │scipy     │ │          │ │        ││
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └────────┘│
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 核心模块

| 模块 | 路径 | 职责 |
|------|------|------|
| **Agent 核心** | `src/data_agent/agent/` | LangGraph 状态机、执行器、LLM 集成 |
| **DAG 系统** | `src/data_agent/dag/` | DAG 模型定义、计划生成、可视化 |
| **状态管理** | `src/data_agent/state/` | Agent 运行状态跟踪 |
| **工具集** | `src/data_agent/tools/` | 数据处理和分析工具实现 |
| **配置** | `src/data_agent/config/` | 设置和提示词管理 |

### 2.3 技术栈

| 分类 | 技术 | 用途 |
|------|------|------|
| **框架** | LangChain + LangGraph | Agent 编排和状态机 |
| **LLM** | 智谱 AI (GLM-4) | 自然语言理解和计划生成 |
| **数据库** | SQLAlchemy + DuckDB | 数据查询和分析 |
| **数据科学** | pandas, numpy, scipy | 数据处理和统计 |
| **机器学习** | scikit-learn | 模型训练和预测 |
| **图分析** | networkx | 网络分析 |
| **沙箱** | MicroSandbox | 安全代码执行 |
| **CLI** | Rich | 命令行美化 |

---

## 三、交互形态

### 3.1 五阶段工作流

```
┌─────────────────────────────────────────────────────────────┐
│                    Agent 工作流程                            │
└─────────────────────────────────────────────────────────────┘

     用户输入
         │
         ▼
   ┌───────────┐
   │ 1. 对话   │  ← 多轮对话，理解用户需求
   │ CONVERSATION│    澄清问题，收集上下文
   └─────┬─────┘
         │ (需求明确后)
         ▼
   ┌───────────┐
   │ 2. 规划   │  ← LLM 自动生成 DAG 执行计划
   │ PLANNING  │    展示 Mermaid 流程图
   └─────┬─────┘
         │
         ▼
   ┌───────────┐
   │ 3. 确认   │  ← 用户审查计划
   │CONFIRMATION│   选择：执行 / 修改 / 取消
   └─────┬─────┘
         │ (用户确认)
         ▼
   ┌───────────┐
   │ 4. 执行   │  ← 按拓扑顺序执行任务
   │ EXECUTION │    实时展示进度
   └─────┬─────┘
         │
         ▼
   ┌───────────┐
   │ 5. 完成   │  ← 汇总结果报告
   │ COMPLETED │
   └───────────┘
```

### 3.2 交互示例

```
用户: 分析 sales 表最近3个月各地区销售额排名

Agent: 我理解您想分析销售数据。请确认以下信息：
       1. 数据源是 MySQL 还是 PostgreSQL？
       2. sales 表的字段结构是什么？

用户: MySQL，字段有 id, product_name, region, amount, date

Agent: 好的，我来生成执行计划：

       📋 执行计划：地区销售额分析
       ┌──────────────────────────────────────────┐
       │  查询销售数据  →  聚合统计  →  排序输出   │
       │  (execute_sql)   (analyze)   (python)   │
       └──────────────────────────────────────────┘

       请确认是否执行？(输入"执行"确认)

用户: 执行

Agent: ✓ 查询销售数据: 完成 (1.2s)
       ✓ 聚合统计: 完成 (0.3s)
       ✓ 排序输出: 完成 (0.1s)

       📊 分析结果：
       华东地区: ¥1,234,567
       华南地区: ¥987,654
       ...
```

### 3.3 CLI 命令

| 命令 | 功能 |
|------|------|
| `help` | 显示帮助信息 |
| `status` | 查看当前状态 |
| `config` | 显示配置信息 |
| `clear` | 清除对话历史 |
| `exit` | 退出程序 |

---

## 四、核心功能

### 4.1 工具能力矩阵

| 工具类别 | 工具名称 | 功能描述 |
|---------|---------|---------|
| **SQL** | execute_sql | MySQL/PostgreSQL 查询 |
| | query_with_duckdb | DuckDB 高性能分析 |
| | query_parquet | Parquet 文件查询 |
| **Python** | execute_python_safe | 沙箱安全执行代码 |
| **数据分析** | analyze_dataframe | DataFrame 描述统计 |
| | statistical_analysis | scipy 统计检验 |
| | analyze_large_dataset | 大数据集分析 |
| **机器学习** | train_model | 模型训练（12种算法） |
| | predict | 模型预测 |
| | evaluate_model | 模型评估 |
| **图分析** | create_graph | 创建图结构 |
| | graph_analysis | 图算法分析（8种） |

### 4.2 支持的机器学习算法

**分类算法**: 逻辑回归、决策树、随机森林、SVM、KNN、朴素贝叶斯

**回归算法**: 线性回归、Ridge、Lasso、决策树回归、随机森林回归、SVR、KNN回归

**聚类算法**: K-Means、DBSCAN

### 4.3 支持的图算法

度分布、中心性分析、聚类系数、连通分量、PageRank、Louvain 社区发现、图密度、最短路径

---

## 五、使用场景

### 5.1 数据探索与分析

**场景**: 业务人员需要快速了解数据特征

```
用户: 帮我分析 users 表的用户画像

Agent 执行:
1. 查询用户数据
2. 统计年龄、性别、地区分布
3. 计算关键指标（活跃度、留存率等）
4. 生成分析报告
```

### 5.2 销售数据分析

**场景**: 分析销售趋势和地区表现

```
用户: 对比各产品线最近6个月的销售趋势

Agent 执行:
1. 查询销售数据
2. 按产品线和月份聚合
3. 计算环比、同比增长
4. 生成趋势图表
```

### 5.3 预测建模

**场景**: 构建客户流失预测模型

```
用户: 基于用户行为数据预测客户流失

Agent 执行:
1. 提取特征数据
2. 数据预处理
3. 训练随机森林模型
4. 评估模型效果
5. 输出特征重要性
```

### 5.4 关系网络分析

**场景**: 分析用户社交关系

```
用户: 分析用户关注关系，找出核心用户

Agent 执行:
1. 构建关注关系图
2. 计算 PageRank
3. 识别关键节点
4. 社区发现
```

### 5.5 大数据文件分析

**场景**: 分析 GB 级 Parquet 文件

```
用户: 分析 sales_2024.parquet 文件的数据质量

Agent 执行:
1. DuckDB 加载文件（无需全量读入内存）
2. 统计缺失值、异常值
3. 数据类型检查
4. 生成数据质量报告
```

---

## 六、安全特性

| 安全措施 | 说明 |
|---------|------|
| **SQL 注入防护** | 仅允许 SELECT 查询，禁止 DROP/DELETE/UPDATE 等危险操作 |
| **代码沙箱隔离** | Python 代码在 MicroSandbox 中执行，无法访问系统资源 |
| **内存限制** | DuckDB 内存限制 4GB，沙箱内存限制 2GB |
| **迭代次数限制** | 最大迭代 10 次，防止死循环 |
| **结果行数限制** | SQL 查询最多返回 1000 行 |

---

## 七、配置说明

### 7.1 环境变量

```bash
# 智谱 AI 配置
ZHIPU_API_KEY=your_api_key
ZHIPU_BASE_URL=https://open.bigmodel.cn/api/paas/v4
ZHIPU_MODEL=glm-4

# 数据库配置
DB_CONNECTION=mysql+pymysql://user:pass@host:3306/db

# 沙箱配置
SANDBOX_ENABLED=true
SANDBOX_TIMEOUT=30

# DuckDB 配置
DUCKDB_MEMORY_LIMIT=4GB
DUCKDB_THREADS=4
```

### 7.2 启动方式

```bash
# 安装依赖
pip install -e .

# 运行 Agent
python -m data_agent.main
```

---

## 八、扩展性

项目采用模块化设计，支持以下扩展：

1. **添加新工具** - 在 `tools/` 目录实现新工具，添加到执行器映射表
2. **切换 LLM** - 修改 `zhipu_llm.py` 支持其他 LLM（OpenAI、Claude 等）
3. **扩展数据库** - 在 `sql_tools.py` 添加新数据库支持
4. **自定义提示词** - 修改 `config/prompts.py` 调整 Agent 行为
